import React, { useState, useRef, useEffect } from 'react'
import GoogleMapReact from 'google-map-react'
import io from "socket.io-client"
import './map.css'


const LocationPin = ({tag, alt, spd, state}) => (
    <div className="pin">
        <svg id="Capa_1" enable-background="new 0 0 512 512" height="512" viewBox="0 0 512 512" width="512" xmlns="http://www.w3.org/2000/svg"><g><g fill="#e4ecfe"><circle cx="107.544" cy="107.544" r="97.544"/><circle cx="404.456" cy="107.544" r="97.544"/><circle cx="404.456" cy="404.456" r="97.544"/><circle cx="107.544" cy="404.456" r="97.544"/></g><path d="m336.729 256c-.18-32.792 12.373-64.818 35.562-88.006l33.485-33.485-28.284-28.284-33.485 33.485c-23.188 23.188-55.312 35.742-88.105 35.562-32.793.18-64.72-12.374-87.908-35.562l-33.485-33.485-28.284 28.284 33.485 33.485c23.188 23.188 35.742 55.214 35.562 88.006.18 32.792-12.373 64.818-35.562 88.006l-33.485 33.485 28.284 28.284 33.486-33.485c23.188-23.188 55.443-35.741 88.235-35.562 32.792-.18 64.589 12.374 87.777 35.562l33.486 33.485 28.284-28.284-33.485-33.485c-23.189-23.188-35.743-55.214-35.563-88.006z" fill="#93b5fd"/><circle cx="256" cy="256" fill="#fff" r="32"/><g fill="#f2cc73"><circle cx="107.544" cy="107.544" r="26.909"/><circle cx="404.456" cy="107.544" r="26.909"/><circle cx="404.456" cy="404.456" r="26.909"/><circle cx="107.544" cy="404.456" r="26.909"/></g><g><path d="m404.456 296.912c-16.023 0-31.773 3.567-46.113 10.374-7.631-15.7-11.712-33.343-11.614-51.285 0-.037 0 .037 0 0-.099-17.942 3.983-35.585 11.614-51.285 14.34 6.806 30.09 10.373 46.113 10.373 59.3 0 107.544-48.244 107.544-107.544 0-59.301-48.244-107.545-107.544-107.545s-107.544 48.244-107.544 107.544c0 16.028 3.569 31.781 10.379 46.125-15.702 7.642-33.446 11.73-51.389 11.602-.036 0 .036 0 0 0-.212.001.212.002 0 .002-17.722 0-35.671-4.076-51.186-11.618 6.806-14.34 10.373-30.089 10.373-46.111-.001-59.3-48.245-107.544-107.545-107.544s-107.544 48.244-107.544 107.544 48.244 107.544 107.544 107.544c16.023 0 31.773-3.567 46.113-10.374 7.631 15.7 11.712 33.343 11.614 51.285.099 17.942-3.983 35.585-11.614 51.285-14.34-6.807-30.09-10.374-46.113-10.374-59.3.002-107.544 48.246-107.544 107.546s48.244 107.544 107.544 107.544 107.544-48.244 107.544-107.544c0-16.023-3.567-31.772-10.373-46.112 15.703-7.633 33.578-11.715 51.514-11.615.212-.001-.212-.002 0-.002 17.722 0 35.54 4.076 51.055 11.618-6.806 14.34-10.373 30.089-10.373 46.111 0 12.27 2.052 24.309 6.1 35.783 1.449 4.108 5.309 6.676 9.431 6.676 1.104 0 2.227-.185 3.327-.572 5.208-1.837 7.941-7.549 6.104-12.757-3.292-9.332-4.961-19.132-4.961-29.13 0-12.38 2.619-24.551 7.616-35.73 4.396 3.226 8.549 6.777 12.408 10.636l31.105 31.105c.693 4.253 2.12 8.317 4.218 12.044l-15.563 15.563c-3.905 3.905-3.906 10.237 0 14.142 1.953 1.953 4.512 2.929 7.071 2.929s5.119-.977 7.071-2.929l15.573-15.573c5.585 3.128 11.813 4.703 18.046 4.703 9.452 0 18.903-3.598 26.099-10.793 11.939-11.94 13.962-30.088 6.089-44.144l15.573-15.573c3.905-3.905 3.905-10.237 0-14.142s-10.237-3.905-14.142 0l-15.563 15.563c-3.728-2.098-7.791-3.525-12.044-4.218l-31.106-31.105c-3.859-3.859-7.409-8.012-10.635-12.408 11.179-4.996 23.35-7.615 35.729-7.615 48.272 0 87.544 39.272 87.544 87.544s-39.273 87.545-87.545 87.545c-8.89 0-17.655-1.325-26.052-3.939-5.274-1.643-10.878 1.303-12.52 6.577-1.641 5.273 1.303 10.878 6.577 12.52 10.323 3.213 21.088 4.842 31.996 4.842 59.299 0 107.543-48.244 107.543-107.544s-48.244-107.544-107.544-107.544zm-87.544-189.368c0-48.272 39.272-87.544 87.544-87.544s87.544 39.272 87.544 87.544-39.272 87.544-87.544 87.544c-12.379 0-24.55-2.619-35.729-7.615 3.226-4.396 6.776-8.549 10.635-12.408l31.105-31.105c4.253-.693 8.316-2.12 12.044-4.218l15.563 15.563c1.953 1.953 4.512 2.929 7.071 2.929s5.119-.977 7.071-2.929c3.905-3.905 3.906-10.237 0-14.142l-15.573-15.573c7.873-14.056 5.85-32.204-6.09-44.145-11.94-11.94-30.088-13.961-44.144-6.089l-15.573-15.573c-3.905-3.905-10.237-3.905-14.142 0s-3.905 10.237 0 14.142l15.563 15.563c-2.098 3.728-3.525 7.792-4.218 12.045l-31.105 31.105c-3.859 3.859-8.011 7.41-12.407 10.638-4.996-11.18-7.615-23.352-7.615-35.732zm99.5 11.956c-3.193 3.194-7.44 4.953-11.956 4.953-4.517 0-8.763-1.759-11.956-4.953-3.193-3.193-4.953-7.439-4.953-11.956 0-4.516 1.759-8.763 4.953-11.956 3.296-3.297 7.625-4.945 11.956-4.945 4.329 0 8.66 1.649 11.956 4.944 6.593 6.594 6.593 17.321 0 23.913zm-308.868 75.588c-48.272 0-87.544-39.272-87.544-87.544s39.272-87.544 87.544-87.544 87.544 39.272 87.544 87.544c0 12.38-2.619 24.551-7.616 35.73-4.396-3.226-8.549-6.777-12.408-10.636l-31.105-31.104c-.693-4.253-2.12-8.317-4.218-12.045l15.563-15.563c3.905-3.905 3.906-10.237 0-14.142-3.905-3.906-10.237-3.905-14.142 0l-15.572 15.572c-14.056-7.872-32.204-5.849-44.145 6.09-11.94 11.94-13.962 30.088-6.089 44.144l-15.573 15.573c-3.905 3.905-3.905 10.237 0 14.142 1.953 1.953 4.512 2.929 7.071 2.929s5.119-.977 7.071-2.929l15.563-15.563c3.728 2.098 7.792 3.525 12.045 4.218l31.105 31.105c3.859 3.859 7.409 8.012 10.635 12.408-11.179 4.996-23.35 7.615-35.729 7.615zm11.956-99.5c3.194 3.193 4.953 7.44 4.953 11.956 0 4.517-1.759 8.763-4.953 11.956-3.193 3.193-7.439 4.953-11.956 4.953-4.516 0-8.763-1.759-11.956-4.953-6.593-6.592-6.593-17.319 0-23.912 3.297-3.297 7.626-4.945 11.957-4.945 4.329 0 8.66 1.649 11.955 4.945zm75.588 308.868c0 48.272-39.272 87.544-87.544 87.544s-87.544-39.272-87.544-87.544 39.272-87.544 87.544-87.544c12.379 0 24.55 2.619 35.729 7.615-3.226 4.396-6.776 8.55-10.635 12.409l-31.104 31.105c-4.253.693-8.317 2.12-12.045 4.218l-15.563-15.563c-3.905-3.906-10.237-3.905-14.142 0s-3.906 10.237 0 14.142l15.573 15.573c-7.873 14.056-5.85 32.204 6.09 44.145 7.195 7.195 16.647 10.792 26.098 10.792 6.232 0 12.461-1.575 18.046-4.703l15.573 15.573c1.953 1.953 4.512 2.929 7.071 2.929s5.119-.977 7.071-2.929c3.905-3.905 3.905-10.237 0-14.142l-15.563-15.563c2.098-3.728 3.525-7.791 4.218-12.044l31.105-31.105c3.859-3.859 8.013-7.408 12.409-10.634 4.994 11.176 7.613 23.347 7.613 35.726zm-99.5-11.956c3.193-3.194 7.44-4.953 11.956-4.953 4.517 0 8.763 1.759 11.956 4.953 3.193 3.193 4.953 7.439 4.953 11.956 0 4.516-1.759 8.763-4.953 11.956-6.591 6.593-17.319 6.593-23.912 0s-6.593-17.32 0-23.912zm320.825 23.912c-6.593 6.594-17.321 6.593-23.913 0-3.194-3.193-4.953-7.44-4.953-11.956 0-4.517 1.759-8.763 4.953-11.956 3.193-3.193 7.439-4.953 11.956-4.953 4.516 0 8.763 1.759 11.956 4.953 6.593 6.592 6.593 17.319.001 23.912zm-30.012-44.154c-2.909 1.637-5.618 3.674-8.043 6.099s-4.462 5.134-6.099 8.043l-21.181-21.181c-24.487-24.487-59.31-38.493-94.848-38.493-.229 0 .229 0 0 .002-35.795-.218-70.661 13.845-95.306 38.491l-21.182 21.181c-1.637-2.909-3.674-5.617-6.099-8.042-2.425-2.426-5.134-4.462-8.043-6.1l21.18-21.181c24.646-24.646 38.673-59.295 38.491-95.078.182-35.782-13.845-70.432-38.491-95.077l-21.181-21.181c2.909-1.637 5.618-3.674 8.043-6.099s4.462-5.134 6.1-8.043l21.181 21.18c24.487 24.488 59.441 38.493 94.979 38.493.229 0-.229 0 0-.002.231.001-.231.002 0 .002 35.536 0 70.69-14.007 95.176-38.493l21.181-21.181c1.637 2.909 3.674 5.618 6.099 8.043 2.425 2.426 5.134 4.462 8.043 6.1l-21.18 21.181c-24.646 24.646-38.673 59.295-38.491 95.078-.182 35.782 13.845 70.432 38.491 95.077z"/><path d="m256 214c-23.159 0-42 18.841-42 42s18.841 42 42 42 42-18.841 42-42-18.841-42-42-42zm0 64c-12.131 0-22-9.869-22-22s9.869-22 22-22 22 9.869 22 22-9.869 22-22 22z"/><circle cx="336.73" cy="474.647" r="10"/></g></g></svg>
        <p className="pin-text">
            Tag: {tag}<br/>
            Altitude: {alt}<br/>
            Airspeed: {spd}<br/>
            State: {state}<br/>
        </p>
    </div>
)

const defaultLocation = {
    lat: 0.0,
    lng: 0.0,
}

const defaultZoom = 1;


function Map() {
    // Keep track of the drones in flight
    const [drones, setDrones] = useState([]);
    const [mapObj, setMapObj] = useState(null);
    const [mapsApi, setMapsApi] = useState(null);
    const socketRef = useRef();

    useEffect(() => {
        socketRef.current = io.connect('http://transponder.pgh.cloudapp.azurelel.cs.cmu.edu:8080');
        socketRef.current.on("update_drone_data", data => {
            updateDrones(JSON.parse(data)['drones']);
        });

        return () => socketRef.current.disconnect();
    }, []);

    const updateDrones = (newDrones) => {
        setDrones(newDrones);
    }
    
    var lineSymbol = {
        path: 'M 0,-1 0,1',
        strokeOpacity: 1,
        scale: 4
      };

    const renderLocationPins = () => {
	for (var i = 0; i < drones.length; i++) {
	    const {tag, lat, lng, alt, spd, state, plan} = drones[i];
            let nonGeodesicPolyline = new mapsApi.Polyline({
	      path: plan,
              geodesic: false,
              strokeColor: '#2596be',
              strokeWeight: 3,
              strokeOpacity: 0,
              icons: [{
                icon: lineSymbol,
                offset: '0',
                repeat: '20px'
              }],
            });
	    nonGeodesicPolyline.setMap(mapObj);
	}
        return drones.map((drone, index) => {
            const {tag, lat, lng, alt, spd, state, plan} = drone
            return (
                <LocationPin
                    lat={lat}
                    lng={lng}
                    tag={tag}
		    alt={alt}
		    spd={spd}
		    state={state}
                />
            )
        })
    }

    const setMaps = (map, maps) => {
	setMapObj(map);
	setMapsApi(maps);
    }

    return (
        <div className="map">
            <h2 className="map-h2">Drone Locator</h2>
            <div className="google-map">
                <GoogleMapReact
                bootstrapURLKeys={{ key: 'AIzaSyBpyDWnlZ29cIBES0R17rkp3woN3RF5txU' }}
                defaultCenter={defaultLocation}
                defaultZoom={defaultZoom}
	        yesIWantToUseGoogleMapApiInternals
	    	onGoogleApiLoaded={({map, maps}) => setMaps(map, maps)}>
                    {renderLocationPins()}
                </GoogleMapReact>
            </div>
        </div>
    )
}

export default Map
